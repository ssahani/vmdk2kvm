# vsphere-download-stabilize-smoke-rhel10.yaml
#
# End-to-end:
#   vSphere (control-plane via pyvmomi) + virt-v2v/VDDK (data-plane download)
#   -> then stabilizeall fixers
#   -> then smoke test
#
# Run:
#   export VC_PASSWORD='test@1234'
#   sudo -E ./vmdk2kvm.py --config vsphere-download-stabilize-smoke-rhel10.yaml vsphere

command: vsphere

# ------------------------------------------------------------------
# vCenter connection (pyvmomi control-plane)
# ------------------------------------------------------------------
vcenter: 10.73.213.134
vc_user: administrator@vsphere.local
vc_password_env: VC_PASSWORD
vc_insecure: true

# ------------------------------------------------------------------
# IMPORTANT: credential aliases used across code paths
# ------------------------------------------------------------------
vs_host: 10.73.213.134
vs_user: administrator@vsphere.local
vs_password_env: VC_PASSWORD
vs_no_verify: true

# ------------------------------------------------------------------
# Download/export from vSphere using virt-v2v (THIS is the "download")
# ------------------------------------------------------------------
vs_v2v: true
vs_vm: esx8.0-rhel10.0beta-x86_64-efi
vs_datacenter: ha-datacenter
vs_transport: vddk

# VDDK (required for vddk transport)
vs_vddk_libdir: /opt/vmware-vix-disklib-distrib
# vs_vddk_thumbprint: "AA:BB:..."   # optional (auto-compute if verify enabled)
# vs_no_verify: true                # (already set) less secure, skip thumbprint

# Optional: snapshot handling (usually OFF unless SAN mode etc.)
vs_create_snapshot: false
# vs_snapshot_moref: snapshot-123

# Keep simple and deterministic
vs_v2v_concurrency: 1
vs_v2v_extra_args:
  - "-v"
  - "-x"

# Where virt-v2v writes the exported disk(s)
output_dir: ./out/v2v/esx8.0-rhel10.0beta-x86_64-efi
out_format: qcow2
compress: true

# ------------------------------------------------------------------
# After download: run vmdk2kvm pipeline on the exported artifact
# (This is the key change vs "download-only")
# ------------------------------------------------------------------
use_v2v: true         # enable internal processing pipeline stages after export
post_v2v: true        # run post-v2v steps (fixers/tests) on the exported output

# ------------------------------------------------------------------
# Stabilize all offline fixers (your "stabilizeall")
# ------------------------------------------------------------------
stabilizeall: true
# optional toggles if you have them:
# regen_initramfs: true
# fix_grub: true
# fix_fstab: true
# fix_network: true

# ------------------------------------------------------------------
# Smoke test (choose one)
# ------------------------------------------------------------------
libvirt_test: false
qemu_test: true

uefi: true
memory: 2048
vcpus: 1
timeout: 120
headless: true

# Logging / reporting
verbose: 1
report: vsphere-download-stabilize-smoke-rhel10.md
